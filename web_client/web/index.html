<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client</title>
  <meta http-equiv="Permissions-Policy" content="display-capture=*">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* LOGIN */
    #loginScreen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }
    #loginScreen p {
      color: #333;
      font-size: 11px;
      letter-spacing: 3px;
    }
    #codeInput {
      background: #0a0a0a;
      border: 1px solid #1a1a1a;
      border-radius: 12px;
      color: #fff;
      font-size: 22px;
      padding: 12px 22px;
      text-align: center;
      width: 90px;
      outline: none;
      letter-spacing: 8px;
    }
    #loginError {
      color: #e53935;
      font-size: 11px;
      min-height: 14px;
    }

    /* WINDOW MODE */
    #windowScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }
    #dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #222;
      transition: background 0.3s;
    }
    #dot.green { background: #4caf50; }
    #wStatus { font-size: 12px; color: #444; }
    .btn {
      padding: 12px 38px;
      border: none;
      border-radius: 22px;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn:active { opacity: 0.7; }
    #startBtn { background: #fff; color: #000; }
    #stopBtn  { background: #c62828; color: #fff; display: none; }

    /* ADMIN MODE */
    #adminScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      min-height: 100vh;
      padding: 20px 14px 40px;
      gap: 16px;
      overflow-y: auto;
    }
    #adminLabel {
      color: #2e7d32;
      font-size: 10px;
      letter-spacing: 4px;
    }
    #noImage { color: #222; font-size: 13px; margin-top: 20px; }
    #screenshot {
      max-width: 96vw;
      max-height: 55vh;
      border-radius: 10px;
      border: 1px solid #111;
      display: none;
      object-fit: contain;
    }
    #answerRow {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }
    #answerInput {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 10px;
      color: #fff;
      font-size: 24px;
      padding: 10px 16px;
      text-align: center;
      width: 70px;
      outline: none;
      text-transform: uppercase;
    }
    #sendBtn {
      background: #2e7d32;
      color: #fff;
      padding: 11px 24px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
    }
    #sendBtn:active { opacity: 0.7; }
    #confirm {
      color: #4caf50;
      font-size: 14px;
      font-weight: bold;
      min-height: 18px;
    }
    #adminTime {
      color: #222;
      font-size: 10px;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginScreen">
    <p>ENTER CODE</p>
    <input id="codeInput" maxlength="1" autofocus autocomplete="off" />
    <div id="loginError"></div>
  </div>

  <!-- WINDOW MODE (screen sharing device) -->
  <div id="windowScreen">
    <div id="dot"></div>
    <div id="wStatus">Press Start</div>
    <button class="btn" id="startBtn">Start</button>
    <button class="btn" id="stopBtn">Stop</button>
  </div>

  <!-- ADMIN MODE (any device: phone, laptop, etc) -->
  <div id="adminScreen">
    <div id="adminLabel">ADMIN</div>
    <div id="noImage">Waiting for screenshot...</div>
    <img id="screenshot" alt="" />
    <div id="answerRow">
      <input id="answerInput" maxlength="1" placeholder="?" autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
    <div id="confirm"></div>
    <div id="adminTime"></div>
  </div>

  <script>
    const WS_URL   = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host;
    const HTTP_URL = location.protocol + '//' + location.host;
    const SKIP     = { 'ngrok-skip-browser-warning': '1', 'Content-Type': 'application/json' };

    // ── LOGIN ──
    document.getElementById('codeInput').addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      const code = this.value.trim().toLowerCase();
      if (code === 'w') {
        switchTo('windowScreen');
      } else if (code === 'a') {
        switchTo('adminScreen');
        startAdmin();
      } else {
        document.getElementById('loginError').textContent = 'invalid code';
        this.value = '';
      }
    });

    function switchTo(id) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById(id).style.display = 'flex';
    }

    // ── WINDOW MODE ──
    let socket = null;
    let stream = null;

    document.getElementById('startBtn').addEventListener('click', async () => {
      setWStatus('Requesting permission...');
      try {
        stream = await navigator.mediaDevices.getDisplayMedia({
          video: { cursor: 'always' },
          audio: false
        });
        setWStatus('Connecting...');
        connectWS();
      } catch (e) {
        setWStatus('Error: ' + e.message);
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      if (socket) socket.close();
      setConnected(false);
      setWStatus('Stopped');
    });

    function connectWS() {
      socket = new WebSocket(WS_URL);
      socket.onopen    = () => { setConnected(true); setWStatus('Connected'); };
      socket.onclose   = () => { setConnected(false); setWStatus('Disconnected'); };
      socket.onerror   = () => { setWStatus('Connection error'); };
      socket.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'capture') await doCapture();
      };
    }

    async function doCapture() {
      setWStatus('Capturing...');
      try {
        const track = stream.getVideoTracks()[0];
        if (!track || track.readyState === 'ended') {
          setWStatus('Stream ended - click Start again');
          return;
        }
        const video = document.createElement('video');
        video.srcObject = new MediaStream([track]);
        video.muted = true;
        await video.play();
        await new Promise(r => requestAnimationFrame(r));
        const canvas = document.createElement('canvas');
        canvas.width  = video.videoWidth  || 1920;
        canvas.height = video.videoHeight || 1080;
        canvas.getContext('2d').drawImage(video, 0, 0);
        socket.send(JSON.stringify({
          type: 'screenshot',
          image: canvas.toDataURL('image/jpeg', 0.7)
        }));
        setWStatus('Sent ✓');
      } catch (e) {
        setWStatus('Error: ' + e.message);
      }
    }

    function setConnected(val) {
      document.getElementById('dot').className = val ? 'green' : '';
      document.getElementById('startBtn').style.display = val ? 'none' : 'block';
      document.getElementById('stopBtn').style.display  = val ? 'block' : 'none';
    }

    function setWStatus(msg) {
      document.getElementById('wStatus').textContent = msg;
    }

    // ── ADMIN MODE ──
    let lastSrc = null;

    function startAdmin() {
      fetchImage();
      setInterval(fetchImage, 2000);
      document.getElementById('answerInput').focus();
    }

    async function fetchImage() {
      try {
        const res  = await fetch(HTTP_URL + '/last-image', { headers: SKIP });
        const data = await res.json();
        if (data.image && data.image !== lastSrc) {
          lastSrc = data.image;
          const img = document.getElementById('screenshot');
          img.src = data.image;
          img.style.display = 'block';
          document.getElementById('noImage').style.display = 'none';
          document.getElementById('adminTime').textContent =
            'Last update: ' + new Date().toLocaleTimeString();
          document.getElementById('answerInput').focus();
        }
      } catch (_) {}
    }

    document.getElementById('answerInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') sendAnswer();
    });
    document.getElementById('sendBtn').addEventListener('click', sendAnswer);

    async function sendAnswer() {
      const val = document.getElementById('answerInput').value.trim();
      if (!val) return;
      try {
        const res  = await fetch(HTTP_URL + '/answer', {
          method: 'POST',
          headers: SKIP,
          body: JSON.stringify({ answer: val })
        });
        const data = await res.json();
        if (data.status === 'ok') {
          document.getElementById('confirm').textContent = '✓  ' + data.answer.toUpperCase();
          document.getElementById('answerInput').value = '';
          setTimeout(() => {
            document.getElementById('confirm').textContent = '';
          }, 2500);
        }
      } catch (_) {}
    }
  </script>
</body>
</html>