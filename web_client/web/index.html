<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #loginScreen { display: flex; flex-direction: column; align-items: center; gap: 14px; }
    #loginScreen p { color: #333; font-size: 11px; letter-spacing: 3px; }
    #codeInput {
      background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 12px;
      color: #fff; font-size: 22px; padding: 12px 22px; text-align: center;
      width: 90px; outline: none; letter-spacing: 8px;
    }
    #loginError { color: #e53935; font-size: 11px; min-height: 14px; }

    #windowScreen { display: none; flex-direction: column; align-items: center; gap: 18px; }
    #dot { width: 10px; height: 10px; border-radius: 50%; background: #222; transition: background 0.3s; }
    #dot.green { background: #4caf50; }
    #wStatus { font-size: 12px; color: #444; }
    #wHint { font-size: 11px; color: #c62828; max-width: 300px; text-align: center; line-height: 1.5; }
    .btn { padding: 12px 38px; border: none; border-radius: 22px; font-size: 14px; cursor: pointer; }
    .btn:active { opacity: 0.7; }
    #startBtn { background: #fff; color: #000; }
    #stopBtn  { background: #c62828; color: #fff; display: none; }

    #adminScreen {
      display: none; flex-direction: column; align-items: center;
      width: 100vw; min-height: 100vh; padding: 20px 14px 40px; gap: 16px; overflow-y: auto;
    }
    #adminLabel { color: #2e7d32; font-size: 10px; letter-spacing: 4px; }
    #noImage { color: #222; font-size: 13px; margin-top: 20px; }
    #screenshot {
      max-width: 96vw; max-height: 55vh; border-radius: 10px;
      border: 1px solid #111; display: none; object-fit: contain;
    }
    #answerRow { display: flex; gap: 10px; align-items: center; margin-top: 4px; }
    #answerInput {
      background: #0a0a0a; border: 1px solid #222; border-radius: 10px;
      color: #fff; font-size: 24px; padding: 10px 16px; text-align: center;
      width: 70px; outline: none; text-transform: uppercase;
    }
    #sendBtn {
      background: #2e7d32; color: #fff; padding: 11px 24px; border: none;
      border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;
    }
    #sendBtn:active { opacity: 0.7; }
    #confirm { color: #4caf50; font-size: 14px; font-weight: bold; min-height: 18px; }
    #adminTime { color: #222; font-size: 10px; }
  </style>
</head>
<body>

  <div id="loginScreen">
    <p>ENTER CODE</p>
    <input id="codeInput" maxlength="1" autofocus autocomplete="off" />
    <div id="loginError"></div>
  </div>

  <div id="windowScreen">
    <div id="dot"></div>
    <div id="wStatus">Press Start</div>
    <div id="wHint"></div>
    <button class="btn" id="startBtn">Start</button>
    <button class="btn" id="stopBtn">Stop</button>
  </div>

  <div id="adminScreen">
    <div id="adminLabel">ADMIN</div>
    <div id="noImage">Waiting for screenshot...</div>
    <img id="screenshot" alt="" />
    <div id="answerRow">
      <input id="answerInput" maxlength="1" placeholder="?" autocomplete="off" />
      <button id="sendBtn">Send</button>
    </div>
    <div id="confirm"></div>
    <div id="adminTime"></div>
  </div>

  <script>
    const BASE    = location.protocol + '//' + location.host;
    const WS_URL  = (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host;
    const HEADERS = { 'ngrok-skip-browser-warning': '1', 'Content-Type': 'application/json' };

    // ── LOGIN ──
    document.getElementById('codeInput').addEventListener('keydown', function(e) {
      if (e.key !== 'Enter') return;
      const code = this.value.trim().toLowerCase();
      if (code === 'w') { switchTo('windowScreen'); }
      else if (code === 'a') { switchTo('adminScreen'); startAdmin(); }
      else { document.getElementById('loginError').textContent = 'invalid code'; this.value = ''; }
    });

    function switchTo(id) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById(id).style.display = 'flex';
    }

    // ══════════════════════════════════════════════
    // WINDOW MODE — WebSocket (instant capture)
    // ══════════════════════════════════════════════
    let stream = null;
    let ws = null;
    let isCapturing = false;

    document.getElementById('startBtn').addEventListener('click', async () => {
      setWStatus('Requesting screen permission...');
      document.getElementById('wHint').textContent = '⚠️ Choose "Entire Screen" not a tab!';

      try {
        stream = await navigator.mediaDevices.getDisplayMedia({
          video: { cursor: 'always', displaySurface: 'monitor' },
          audio: false,
          preferCurrentTab: false
        });

        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();

        if (settings.displaySurface === 'browser') {
          document.getElementById('wHint').textContent = '⚠️ You chose a TAB. Restart and pick "Entire Screen".';
        } else {
          document.getElementById('wHint').textContent = '';
        }

        track.addEventListener('ended', () => { stopWindow(); setWStatus('Stream ended'); });

        // Connect WebSocket
        connectWindowsWS();
      } catch (e) {
        setWStatus('Error: ' + e.message);
        document.getElementById('wHint').textContent = '';
      }
    });

    function connectWindowsWS() {
      setWStatus('Connecting...');
      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'register', role: 'windows' }));
        setConnected(true);
        setWStatus('Connected ✓');
      };

      ws.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'capture') {
          await doCapture();
        }
      };

      ws.onclose = () => {
        setConnected(false);
        setWStatus('Disconnected');
        // Auto-reconnect if stream still active
        if (stream && stream.getVideoTracks()[0]?.readyState === 'live') {
          setTimeout(connectWindowsWS, 3000);
        }
      };

      ws.onerror = () => { setWStatus('Connection error'); };
    }

    document.getElementById('stopBtn').addEventListener('click', stopWindow);

    function stopWindow() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      if (ws) { ws.close(); ws = null; }
      setConnected(false);
      setWStatus('Stopped');
    }

    async function doCapture() {
      if (isCapturing) return;
      isCapturing = true;
      setWStatus('Capturing...');

      try {
        const track = stream.getVideoTracks()[0];
        if (!track || track.readyState === 'ended') {
          setWStatus('Stream ended');
          isCapturing = false;
          return;
        }

        const video = document.createElement('video');
        video.srcObject = new MediaStream([track]);
        video.muted = true;
        await video.play();
        await new Promise(r => setTimeout(r, 150));

        const canvas = document.createElement('canvas');
        canvas.width  = video.videoWidth  || 1920;
        canvas.height = video.videoHeight || 1080;
        canvas.getContext('2d').drawImage(video, 0, 0);
        video.pause();
        video.srcObject = null;

        const imageData = canvas.toDataURL('image/jpeg', 0.7);

        // Send screenshot via WebSocket (fast!)
        ws.send(JSON.stringify({ type: 'screenshot', image: imageData }));
        setWStatus('Sent ✓ (' + new Date().toLocaleTimeString() + ')');
      } catch (e) {
        setWStatus('Error: ' + e.message);
      } finally {
        isCapturing = false;
      }
    }

    function setConnected(val) {
      document.getElementById('dot').className = val ? 'green' : '';
      document.getElementById('startBtn').style.display = val ? 'none' : 'block';
      document.getElementById('stopBtn').style.display  = val ? 'block' : 'none';
    }
    function setWStatus(msg) { document.getElementById('wStatus').textContent = msg; }

    // ══════════════════════════
    // ADMIN MODE (HTTP polling)
    // ══════════════════════════
    let lastSrc = null;

    function startAdmin() {
      fetchImage();
      setInterval(fetchImage, 2000);
      document.getElementById('answerInput').focus();
    }

    async function fetchImage() {
      try {
        const res  = await fetch(BASE + '/last-image', { headers: HEADERS });
        const data = await res.json();
        if (data.image && data.image !== lastSrc) {
          lastSrc = data.image;
          document.getElementById('screenshot').src = data.image;
          document.getElementById('screenshot').style.display = 'block';
          document.getElementById('noImage').style.display = 'none';
          document.getElementById('adminTime').textContent = 'Last update: ' + new Date().toLocaleTimeString();
          document.getElementById('answerInput').focus();
        }
      } catch (_) {}
    }

    document.getElementById('answerInput').addEventListener('keydown', e => { if (e.key === 'Enter') sendAnswer(); });
    document.getElementById('sendBtn').addEventListener('click', sendAnswer);

    async function sendAnswer() {
      const val = document.getElementById('answerInput').value.trim();
      if (!val) return;
      try {
        const res = await fetch(BASE + '/answer', {
          method: 'POST', headers: HEADERS,
          body: JSON.stringify({ answer: val })
        });
        const data = await res.json();
        if (data.status === 'ok') {
          document.getElementById('confirm').textContent = '✓  ' + data.answer.toUpperCase();
          document.getElementById('answerInput').value = '';
          setTimeout(() => { document.getElementById('confirm').textContent = ''; }, 2500);
        }
      } catch (_) {}
    }
  </script>
</body>
</html>